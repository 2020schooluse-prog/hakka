<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢èªåœ°åœ–å¤§é—–é—œ - ğŸŒ¸ éŒ¯é¡Œå¼·åŒ–ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ffb7c5;
            --correct: #4caf50;
            --wrong: #f44336;
            --bg-overlay: rgba(255, 255, 255, 0.94);
        }

        body, html {
            height: 100vh; margin: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background: #fff5f7 url('https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&q=80&w=2000') no-repeat center center fixed;
            background-size: cover;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }

        /* é—–é—œåœ°åœ– */
        .map-progress-container {
            width: 90%; max-width: 900px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px; padding: 10px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: space-between;
            position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .map-line {
            position: absolute; top: 50%; left: 5%; right: 5%;
            height: 4px; background: #ccc; z-index: 1; transform: translateY(-50%);
        }

        .city-node {
            width: 45px; height: 45px; background: white; border: 3px solid var(--primary);
            border-radius: 50%; z-index: 2; display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; color: #d63384; font-weight: bold; transition: 0.3s;
        }

        .city-node.active { background: #d63384; color: white; transform: scale(1.2); }

        /* ä¸»å®¹å™¨ */
        .quiz-container {
            width: 90%; max-width: 1000px;
            background: var(--bg-overlay); backdrop-filter: blur(10px);
            padding: 30px; border-radius: 35px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 4px solid white; text-align: center;
        }

        h1 { color: #d63384; font-size: 2.2rem; margin: 0; }
        .mode-tag { color: #888; font-size: 1.1rem; margin-bottom: 15px; font-weight: bold; }

        /* é¡Œç›®æ¡†ï¼šè²¼åˆæ–‡å­— */
        #question-text-wrap { margin-bottom: 30px; }
        #question-text {
            display: inline-block;
            font-size: 2.8rem; 
            padding: 10px 25px;
            background: rgba(214, 51, 132, 0.05);
            border-radius: 20px;
            color: #111; line-height: 1.3; font-weight: 700;
            border: 2px dashed var(--primary);
        }

        .options-grid {
            display: grid; grid-template-columns: 1fr; gap: 20px;
        }

        @media (min-width: 800px) {
            .options-grid { grid-template-columns: 1fr 1fr; gap: 25px; }
        }

        /* é¸é …æŒ‰éˆ•ï¼šè²¼åˆæ–‡å­— */
        .option-btn {
            background: white; border: 4px solid var(--primary);
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 2rem;
            font-weight: 700; cursor: pointer;
            transition: all 0.2s ease;
            color: #333; box-shadow: 0 6px 0px var(--primary);
            display: flex; justify-content: center; align-items: center;
        }

        .option-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 15px rgba(214,51,132,0.15); }
        .correct { background-color: var(--correct) !important; color: white !important; border-color: #2e7d32 !important; box-shadow: 0 6px 0px #2e7d32 !important; }
        .wrong { background-color: var(--wrong) !important; color: white !important; border-color: #b71c1c !important; box-shadow: 0 6px 0px #b71c1c !important; }
        .disabled { pointer-events: none; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }
        .shake { animation: shake 0.4s ease-in-out; }

        #result-screen { display: none; }
        .score-val { font-size: 6rem; color: #d63384; font-weight: bold; margin: 10px 0; }
        .status-msg { font-size: 1.8rem; color: #444; margin-bottom: 20px; }
        
        .next-tour-btn {
            font-size: 2.2rem; padding: 20px 60px; border-radius: 100px; 
            background: #d63384; color: white; border: none; cursor: pointer;
            box-shadow: 0 8px 15px rgba(214, 51, 132, 0.3); transition: 0.3s;
        }
        .next-tour-btn:hover { transform: scale(1.1); background: #c2185b; }
    </style>
</head>
<body>

<div class="map-progress-container">
    <div class="map-line"></div>
    <div class="city-node active" data-step="0">å±æ±</div>
    <div class="city-node" data-step="3">é«˜é›„</div>
    <div class="city-node" data-step="6">å˜‰ç¾©</div>
    <div class="city-node" data-step="9">å°ä¸­</div>
    <div class="city-node" data-step="12">æ–°ç«¹</div>
    <div class="city-node" data-step="15">å°åŒ—</div>
</div>

<div class="quiz-container" id="main-box">
    <div id="game-screen">
        <h1>ğŸŒ¸ å®¢èªåœ°åœ–å¤§é—–é—œ ğŸŒ¸</h1>
        <div class="mode-tag" id="mode-info">æ­£åœ¨æº–å‚™è¡Œå›Š...</div>
        <div id="question-text-wrap"><div id="question-text">è¼‰å…¥ä¸­...</div></div>
        <div id="options" class="options-grid"></div>
    </div>

    <div id="result-screen">
        <h2 id="result-title">ğŸ‰ åˆ°é”å°åŒ—ç«™ï¼</h2>
        <div class="score-val" id="score-text">0</div>
        <div class="status-msg" id="status-msg"></div>
        <button class="next-tour-btn" onclick="location.reload()">ç¹¼çºŒä¸‹ä¸€è¼ªæŒ‘æˆ°</button>
    </div>
</div>

<script>
    let allQuestions = [];
    let currentPool = [];
    let currentIdx = 0;
    let score = 0;
    let isLocked = false;

    async function start() {
        try {
            const resp = await fetch('questions.json');
            allQuestions = await resp.json();
            // ç‚ºé¡Œåº«ç·¨è™Ÿ
            allQuestions.forEach((q, index) => q.id = index);

            // è®€å–éŒ¯é¡Œåº«
            let wrongIds = JSON.parse(localStorage.getItem('hakka_wrong_v3')) || [];
            
            let selected = [];
            // 1. å„ªå…ˆå¡å…¥éŒ¯é¡Œ
            let wrongQuestions = allQuestions.filter(q => wrongIds.includes(q.id));
            selected = wrongQuestions.sort(() => Math.random() - 0.5).slice(0, 15);
            
            // 2. ç”¨æ–°é¡Œè£œè¶³åˆ° 15 é¡Œ
            if (selected.length < 15) {
                let otherQuestions = allQuestions.filter(q => !wrongIds.includes(q.id));
                let needed = 15 - selected.length;
                selected = selected.concat(otherQuestions.sort(() => Math.random() - 0.5).slice(0, needed));
            }
            
            currentPool = selected;
            document.getElementById('mode-info').innerText = 
                wrongIds.length > 0 ? `ğŸš€ æœ¬è¼ªåŒ…å« ${Math.min(wrongIds.length, 15)} é¡Œéœ€è¦åŠ å¼·çš„å…§å®¹` : "ğŸ†• å…¨æ–°éš¨æ©ŸæŒ‘æˆ°ï¼Œå‡ºç™¼ï¼";
            
            render();
        } catch (e) {
            document.getElementById('question-text').innerText = "âŒ ç„¡æ³•è®€å–é¡Œåº«æª”æ¡ˆ";
        }
    }

    function render() {
        if (currentIdx >= currentPool.length) {
            showEnd();
            return;
        }

        isLocked = false;
        const q = currentPool[currentIdx];
        document.getElementById('main-box').classList.remove('shake');
        updateMap();

        document.getElementById('question-text').innerText = q.q;
        const optDiv = document.getElementById('options');
        optDiv.innerHTML = "";

        q.a.forEach((txt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = txt;
            btn.onclick = () => check(i, btn);
            optDiv.appendChild(btn);
        });
    }

    function updateMap() {
        const nodes = document.querySelectorAll('.city-node');
        nodes.forEach(node => {
            if (parseInt(node.dataset.step) <= currentIdx) node.classList.add('active');
            else node.classList.remove('active');
        });
    }

    function check(picked, btn) {
        if (isLocked) return;
        isLocked = true;

        const q = currentPool[currentIdx];
        const correct = q.ans;
        const allBtns = document.querySelectorAll('.option-btn');
        let wrongIds = JSON.parse(localStorage.getItem('hakka_wrong_v3')) || [];

        allBtns.forEach(b => b.classList.add('disabled'));

        if (picked === correct) {
            score++;
            btn.classList.add('correct');
            // ç­”å°å°±å¾éŒ¯é¡Œåº«ç§»é™¤
            wrongIds = wrongIds.filter(id => id !== q.id);
        } else {
            btn.classList.add('wrong');
            allBtns[correct].classList.add('correct');
            document.getElementById('main-box').classList.add('shake');
            // ç­”éŒ¯å°±åŠ å…¥éŒ¯é¡Œåº«
            if (!wrongIds.includes(q.id)) wrongIds.push(q.id);
        }

        localStorage.setItem('hakka_wrong_v3', JSON.stringify(wrongIds));

        setTimeout(() => {
            currentIdx++;
            render();
        }, 1200);
    }

    function showEnd() {
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        document.getElementById('score-text').innerText = `${score} / ${currentPool.length}`;
        
        let wrongIds = JSON.parse(localStorage.getItem('hakka_wrong_v3')) || [];
        const msg = document.getElementById('status-msg');
        
        if (wrongIds.length > 0) {
            msg.innerHTML = `åšå¾—å¥½ï¼ç›®å‰é‚„æœ‰ <b style="color:#d63384">${wrongIds.length}</b> é¡Œæœªå®Œå…¨æŒæ¡ã€‚<br>ä¸‹ä¸€è¼ªæœƒå„ªå…ˆå¹«ä½ è¤‡ç¿’ï¼`;
        } else {
            msg.innerHTML = "ğŸ† å¤ªå®Œç¾äº†ï¼ä½ å·²ç¶“ç²¾é€šç›®å‰æ‰€æœ‰æŒ‘æˆ°ï¼";
        }
    }

    start();
</script>

</body>
</html>
