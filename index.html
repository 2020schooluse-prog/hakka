<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢èªåœ°åœ–å¤§é—–é—œ - ğŸŒ¸ é¡Œç›®ä¿®å¾©ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ffb7c5;
            --correct: #4caf50;
            --wrong: #f44336;
            --bg-overlay: rgba(255, 255, 255, 0.94);
        }

        body, html {
            height: 100vh; margin: 0;
            font-family: 'Noto Sans TC', sans-serif;
            /* èƒŒæ™¯åœ–ï¼šæ«»èŠ±å­¸æ ¡é¢¨æ ¼ */
            background: #fff5f7 url('https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&q=80&w=2000') no-repeat center center fixed;
            background-size: cover;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }

        /* é—–é—œåœ°åœ–å€åŸŸ */
        .map-progress-container {
            width: 90%; max-width: 900px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px; padding: 10px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: space-between;
            position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .map-line {
            position: absolute; top: 50%; left: 5%; right: 5%;
            height: 4px; background: #ccc; z-index: 1; transform: translateY(-50%);
        }

        .city-node {
            width: 45px; height: 45px; background: white; border: 3px solid var(--primary);
            border-radius: 50%; z-index: 2; display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; color: #d63384; font-weight: bold; transition: 0.3s;
        }

        .city-node.active { background: #d63384; color: white; transform: scale(1.25); box-shadow: 0 0 10px var(--primary); }

        /* é¡Œç›®ä¸»å®¹å™¨ */
        .quiz-container {
            width: 90%; max-width: 1000px;
            background: var(--bg-overlay); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 35px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 4px solid white; text-align: center;
        }

        h1 { color: #d63384; font-size: 2.2rem; margin: 0 0 5px 0; }
        .mode-tag { color: #888; font-size: 1.1rem; margin-bottom: 15px; font-weight: bold; }

        /* é¡Œç›®æ¡†ï¼šæ¡†å­—è²¼åˆå„ªåŒ– */
        .question-box {
            display: inline-block; /* å¯¬åº¦éš¨å­—è®Šå‹• */
            font-size: 3rem; 
            padding: 8px 25px; /* ç·Šæ¹Šå…§è· */
            background: rgba(214, 51, 132, 0.05);
            border-radius: 20px;
            color: #111; line-height: 1.4; font-weight: 700;
            border: 2px dashed var(--primary);
            margin-bottom: 30px;
        }

        .options-grid {
            display: grid; grid-template-columns: 1fr; gap: 20px;
        }

        @media (min-width: 800px) {
            .options-grid { grid-template-columns: 1fr 1fr; gap: 25px; }
        }

        /* é¸é …æŒ‰éˆ•ï¼šæ¡†å­—è²¼åˆå„ªåŒ– */
        .option-btn {
            background: white; border: 4px solid var(--primary);
            padding: 15px 20px; /* ç·Šç¸® Padding ä½¿å…¶è²¼åˆ */
            border-radius: 20px;
            font-size: 2.2rem; /* å­—é«”ä¾ç„¶å¾ˆå¤§ */
            font-weight: 700; cursor: pointer;
            transition: all 0.2s ease;
            color: #333; box-shadow: 0 6px 0px var(--primary);
            display: flex; justify-content: center; align-items: center;
            min-height: auto; /* ä¸è¨­å›ºå®šé«˜åº¦ï¼Œè®“æ¡†è²¼è‘—å­— */
        }

        .option-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 15px rgba(214,51,132,0.15); }
        .correct { background-color: var(--correct) !important; color: white !important; border-color: #2e7d32 !important; box-shadow: 0 6px 0px #2e7d32 !important; }
        .wrong { background-color: var(--wrong) !important; color: white !important; border-color: #b71c1c !important; box-shadow: 0 6px 0px #b71c1c !important; }
        .disabled { pointer-events: none; }

        #result-screen { display: none; }
        .score-val { font-size: 7rem; color: #d63384; font-weight: bold; margin: 15px 0; }
    </style>
</head>
<body>

<div class="map-progress-container">
    <div class="map-line"></div>
    <div class="city-node active" data-step="0">å±æ±</div>
    <div class="city-node" data-step="3">é«˜é›„</div>
    <div class="city-node" data-step="6">å˜‰ç¾©</div>
    <div class="city-node" data-step="9">å°ä¸­</div>
    <div class="city-node" data-step="12">æ–°ç«¹</div>
    <div class="city-node" data-step="15">å°åŒ—</div>
</div>

<div class="quiz-container" id="main-box">
    <div id="game-screen">
        <h1>ğŸŒ¸ å®¢èªåœ°åœ–å¤§é—–é—œ ğŸŒ¸</h1>
        <div class="mode-tag" id="mode-info">æ­£åœ¨è®€å–é¡Œåº«...</div>
        <div><div id="question-text" class="question-box">è¼‰å…¥ä¸­...</div></div>
        <div id="options" class="options-grid"></div>
    </div>

    <div id="result-screen">
        <h2>ğŸ‰ é—–é—œæˆåŠŸï¼åˆ°é”å°åŒ—ç«™</h2>
        <div class="score-val" id="score-text">0</div>
        <p id="review-msg" style="font-size:1.6rem; color:#444;"></p>
        <button onclick="location.reload()" style="font-size:2rem; padding:15px 50px; border-radius:50px; background:#d63384; color:white; border:none; cursor:pointer; margin-top:20px;">ç¹¼çºŒæŒ‘æˆ°(è¤‡ç¿’éŒ¯é¡Œ)</button>
    </div>
</div>

<script>
    let allQuestions = [];
    let currentPool = [];
    let currentIdx = 0;
    let score = 0;
    let isLocked = false;

    // æ ¸å¿ƒï¼šè¼‰å…¥é¡Œåº«
    async function init() {
        try {
            // å˜—è©¦è®€å–å¤–éƒ¨ JSON
            const resp = await fetch('questions.json');
            if (!resp.ok) throw new Error('File not found');
            allQuestions = await resp.json();
        } catch (e) {
            console.log("è®€å– JSON å¤±æ•—ï¼Œæ”¹ç”¨å…§å»ºé¡Œåº«æ¸¬è©¦");
            // å‚™ç”¨å…§å»ºé¡Œåº« (ç¢ºä¿ä¸€å®šè·‘å¾—å‡ºé¡Œç›®)
            allQuestions = [
                {q: "å£è¹„å’§ï¼ç³–ä»”åˆ†è€å¼Ÿé£Ÿ_____å’§ï¼", a: ["æ·¨æ·¨", "æ·¨ä¿", "æ¸…æ¸…"], ans: 0},
                {q: "è©²å…©å…„å¼Ÿç•¶åƒï¼¿ï¼¿ï¼¿ï¼Œé€æ“ºè¦‹é¢å°±ç›¸åµä»”ã€‚", a: ["ç”Ÿä»½äºº", "è‡ªå®¶äºº", "å†¤ä»‡äºº"], ans: 2},
                {q: "æ³¡ç‰›ä¹³åˆ†å¬°å…’ä»”é£Ÿï¼Œæ„›ç”¨_____ä¾†æ³¡ï¼Œæ­£è¼ƒè¡›ç”Ÿã€‚", a: ["å†·æ°´", "æ»¾æ°´", "æ¶¼æ°´"], ans: 1}
            ];
        }

        // ç‚ºæ¯é¡Œå»ºç«‹å”¯ä¸€ ID
        allQuestions.forEach((q, i) => q.id = (q.id !== undefined) ? q.id : i);
        
        setupRound();
    }

    function setupRound() {
        // è®€å– localStorage çš„éŒ¯é¡Œ ID
        let wrongIds = JSON.parse(localStorage.getItem('hakka_wrongs_final')) || [];
        
        let selected = [];
        // 1. å„ªå…ˆå¡å…¥éŒ¯é¡Œ
        let wrongQuestions = allQuestions.filter(q => wrongIds.includes(q.id));
        selected = wrongQuestions.sort(() => Math.random() - 0.5).slice(0, 15);
        
        // 2. å¦‚æœä¸è¶³ 15 é¡Œï¼Œç”¨éš¨æ©Ÿæ–°é¡Œè£œæ»¿
        if (selected.length < 15) {
            let others = allQuestions.filter(q => !wrongIds.includes(q.id));
            let needed = 15 - selected.length;
            selected = selected.concat(others.sort(() => Math.random() - 0.5).slice(0, needed));
        }
        
        currentPool = selected;
        document.getElementById('mode-info').innerText = 
            wrongIds.length > 0 ? `ğŸ’ª æ­£åœ¨è¤‡ç¿’ ${Math.min(wrongIds.length, 15)} é¡Œå…ˆå‰ç­”éŒ¯çš„å…§å®¹` : "ğŸ†• å…¨æ–°éš¨æ©ŸæŒ‘æˆ°ï¼Œå‡ºç™¼ï¼";
        
        render();
    }

    function render() {
        if (currentIdx >= currentPool.length) {
            showEnd();
            return;
        }

        isLocked = false;
        const q = currentPool[currentIdx];
        document.getElementById('main-box').classList.remove('shake');
        
        // æ›´æ–°åœ°åœ–
        document.querySelectorAll('.city-node').forEach(node => {
            if (parseInt(node.dataset.step) <= currentIdx) node.classList.add('active');
            else node.classList.remove('active');
        });

        document.getElementById('question-text').innerText = q.q;
        const optDiv = document.getElementById('options');
        optDiv.innerHTML = "";

        q.a.forEach((txt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = txt;
            btn.onclick = () => check(i, btn);
            optDiv.appendChild(btn);
        });
    }

    function check(picked, btn) {
        if (isLocked) return;
        isLocked = true;

        const q = currentPool[currentIdx];
        const correct = q.ans;
        const allBtns = document.querySelectorAll('.option-btn');
        let wrongIds = JSON.parse(localStorage.getItem('hakka_wrongs_final')) || [];

        allBtns.forEach(b => b.classList.add('disabled'));

        if (picked === correct) {
            score++;
            btn.classList.add('correct');
            // ç­”å°äº†ï¼Œå¾éŒ¯é¡Œåº«ç§»é™¤
            wrongIds = wrongIds.filter(id => id !== q.id);
        } else {
            btn.classList.add('wrong');
            allBtns[correct].classList.add('correct');
            document.getElementById('main-box').classList.add('shake');
            // ç­”éŒ¯äº†ï¼ŒåŠ å…¥éŒ¯é¡Œåº«
            if (!wrongIds.includes(q.id)) wrongIds.push(q.id);
        }

        localStorage.setItem('hakka_wrongs_final', JSON.stringify(wrongIds));

        setTimeout(() => {
            currentIdx++;
            render();
        }, 1300);
    }

    function showEnd() {
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        document.getElementById('score-text').innerText = `${score} / 15`;
        
        let wrongIds = JSON.parse(localStorage.getItem('hakka_wrongs_final')) || [];
        document.getElementById('review-msg').innerText = 
            wrongIds.length > 0 ? `ç›®å‰é‚„æœ‰ ${wrongIds.length} é¡Œå°šæœªç²¾é€šï¼Œç¹¼çºŒåŠ æ²¹ï¼` : "æ­å–œï¼ä½ å·²ç¶“æŒæ¡äº†æ‰€æœ‰é¡Œç›®ï¼";
    }

    init();
</script>

</body>
</html>
